<!DOCTYPE html>
<html lang="en">

	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="robots" content="noindex, nofollow">

		<title>{{hostname}} - Mail-in-a-Box Control Panel</title>

		<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
		<link rel="stylesheet" href="assets/fontawesome/css/fontawesome.min.css">
		<link rel="stylesheet" href="assets/fontawesome/css/solid.min.css">

		<script src="assets/jquery.min.js"></script>
		<script src="assets/js.cookie.min.js"></script>
		<script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>

		<!-- Templating helpers -->
		<script>
			function fromtemplate(jqs) {
				return $(document.importNode(document.querySelector(jqs).content, true))
			}
		</script>

		<!-- Panel Management Utilities -->
		<script>
			let current_panel = null;
			let panel_functions = {}

			function do_logout() {
				// Clear the session from the backend.
				api("/logout", "POST", {}, () => {
					location.reload()
				});
			}

			function show_panel(panelid) {
				if (panelid.getAttribute) {
					// we might be passed an HTMLElement <a>.
					panelid = panelid.getAttribute('href').substring(1);
				}

				$('.admin-panel').hide();
				$('#panel-' + panelid).show();

				if (current_panel && panel_functions[current_panel]) {
					panel_functions[current_panel].unload()
				}
				if (panel_functions[panelid]) {
					panel_functions[panelid].load();
				}

				current_panel = panelid;

				return false;
			}
		</script>

		<style>
			body {
				overflow-y: scroll;
				padding-bottom: 20px;
			}

			p {
				margin-bottom: 1.25em;
			}

			h1, h2, h3, h4 {
				font-family: sans-serif;
				font-weight: bold;
			}

			h2 {
				margin: 1em 0;
			}

			h3 {
				font-size: 130%;
				border-bottom: 1px solid black;
				padding-bottom: 3px;
				margin-bottom: 13px;
				margin-top: 30px;
			}

			.panel-heading h3 {
				border: none;
				padding: 0;
				margin: 0;
			}

			h4 {
				font-size: 110%;
				margin-bottom: 13px;
				margin-top: 18px;
			}

			h4:first-child {
				margin-top: 6px;
			}

			.admin-panel {
				display: none;
			}

			table.table {
				margin: 1.5em 0;
			}

			ol li {
				margin-bottom: 1em;
			}

			.title {
				margin: 0.5em;
				text-align: center;
			}

			.subtitle {
				margin: 1em;
				text-align: center;
			}

			td.text-muted {
				border-style: none;
			}

			.btn.btn-xs {
				padding: .1rem .3rem;
				font-size: .75rem;
				border-radius: .2rem;
			}
		</style>
	</head>

	{% if darkmode %}
	<body class="darkmode">
	{% else %}
	<body>
	{% endif %}
		<div class="navbar navbar-expand-lg navbar-light" role="navigation">
			<div class="container bg-light pt-2 pb-2">
				{% if authenticated %}
				<div>
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="#navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
				</div>
				{% endif %}
				<div class="navbar-brand ms-2">
					<span class="fas fa-envelope"></span>
					<b>{{hostname}}</b>
				</div>
				<div class="ms-2">
					<span class="me-1 fas fa-sun"></span>
					<span class="form-switch">
						{% if darkmode %}
						<input class="form-check-input" type="checkbox" role="switch" id="navbar-toggle-theme" checked>
						{% else %}
						<input class="form-check-input" type="checkbox" role="switch" id="navbar-toggle-theme">
						{% endif %}
						<label class="ms-1 fas fa-moon"></label>
					</span>
				</div>
				{% if authenticated %}
				<div class="collapse navbar-collapse" id="navbar-menu">
					<ul class="navbar-nav ms-auto">
						{% if is_admin %}
						<li class="nav-item me-1 me-xl-4 dropdown">
							<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown"
								aria-expanded="false">System</button>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="#system-status" onclick="return show_panel(this);">Status Checks</a></li>
								<li><a class="dropdown-item" href="#tls" onclick="return show_panel(this);">TLS (SSL) Certificates</a></li>
								<li><a class="dropdown-item" href="#system-backup" onclick="return show_panel(this);">Backup Status</a></li>
								<li><a class="dropdown-item" href="#smtp-relays" onclick="return show_panel(this);">SMTP Relays</a></li>
							</ul>
						</li>
						<li class="nav-item me-1 me-xl-4 dropdown">
							<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown"
								aria-expanded="false">Advanced</button>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="#custom-dns" onclick="return show_panel(this);">Custom DNS</a></li>
								<li><a class="dropdown-item" href="#external-dns" onclick="return show_panel(this);">External DNS</a></li>
								<li><a class="dropdown-item" href="#pgp-keyring" onclick="return show_panel(this);">PGP Keyring Management</a></li>
								<li><a class="dropdown-item" href="#wkd" onclick="return show_panel(this);">WKD Management</a></li>
								<li><a class="dropdown-item" href="munin" target="_blank">Munin Monitoring</a></li>
							</ul>
						</li>
						<li class="nav-item me-1 me-xl-4 dropdown">
							<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown"
								aria-expanded="false">Mail</button>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" href="#mail-guide" onclick="return show_panel(this);">Mail Guide</a></li>
								<li><a class="dropdown-item" href="#users" onclick="return show_panel(this);">Users</a></li>
								<li><a class="dropdown-item" href="#aliases" onclick="return show_panel(this);">Aliases</a></li>
								<li class="divider"></li>
								<li class="dropdown-header">Your Account</li>
								<li><a class="dropdown-item" href="#mfa" onclick="return show_panel(this);">Two-Factor Authentication</a></li>
							</ul>
						</li>
						<li><button class="nav-item me-1 me-xl-4 btn" type="button" href="#web" onclick="return show_panel(this);">Web</button></li>
						{% else %}
						<li class="nav-item me-1 me-xl-4 btn" type="button" href="#mail-guide" onclick="return show_panel(this);">
							Mail Guide
						</li>
						{% endif %}
						<li><button class="nav-item me-1 me-xl-4 btn" type="button" href="#sync-guide" onclick="return show_panel(this);">Contacts/Calendar</button></li>
						<li><button class="nav-item btn btn-secondary" type="button" onclick="do_logout(); return false;"><b>Logout</b></button></li>
					</ul>
				</div>
				{% endif %}
			</div>
		</div>

		<div class="container">
		{% if authenticated %}
			{% if is_admin %}
			<div id="panel-smtp-relays" class="admin-panel">
				{% include "smtp-relays.html" %}
			</div>

			<div id="panel-system-status" class="admin-panel">
				{% include "system-status.html" %}
			</div>

			<div id="panel-system-backup" class="admin-panel">
				{% include "system-backup.html" %}
			</div>

			<div id="panel-external-dns" class="admin-panel">
				{% include "external-dns.html" %}
			</div>

			<div id="panel-custom-dns" class="admin-panel">
				{% include "custom-dns.html" %}
			</div>

			<div id="panel-pgp-keyring" class="admin-panel">
				{% include "pgp-keyring.html" %}
			</div>

			<div id="panel-wkd" class="admin-panel">
				{% include "wkd.html" %}
			</div>

			<div id="panel-mfa" class="admin-panel">
				{% include "mfa.html" %}
			</div>

			<div id="panel-users" class="admin-panel">
				{% include "users.html" %}
			</div>

			<div id="panel-aliases" class="admin-panel">
				{% include "aliases.html" %}
			</div>

			<div id="panel-web" class="admin-panel">
				{% include "web.html" %}
			</div>

			<div id="panel-tls" class="admin-panel">
				{% include "ssl.html" %}
			</div>
			{% endif %}
			<div id="panel-welcome" class="admin-panel" style="display: block;">
				{% include "welcome.html" %}
			</div>

			<div id="panel-mail-guide" class="admin-panel">
				{% include "mail-guide.html" %}
			</div>

			<div id="panel-sync-guide" class="admin-panel">
				{% include "sync-guide.html" %}
			</div>
		{% else %}
			<div id="panel-login" class="admin-panel" style="display: block;">
				{% include "login.html" %}
			</div>
		{% endif %}

			<hr>

			<footer>
				<p>This is a <a href="https://github.com/ddavness/power-mailinabox">Power Mail-in-a-Box</a>.</p>
			</footer>
		</div> <!-- /container -->

		<div id="global-loading-indicator"
			style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-index: 100000; text-align: center; background-color: rgba(0,0,0,.8)">
			<div class="justify-content-center" style="margin: 20%;">
				<div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;"></div>
				<div class="text-light display-5">Loading... please wait!</div>
			</div>
		</div>

		<div id="global-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="global-modal-title"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="global-modal-title"></h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
					</div>
					<div class="modal-body">
						<p></p>
					</div>
					<div class="modal-footer">
						<button type="button" id="global-modal-btn-default" class="btn btn-default" data-bs-dismiss="modal">No</button>
						<button type="button" id="global-modal-btn-confirm" class="btn btn-danger" data-bs-dismiss="modal">Yes</button>
					</div>
				</div>
			</div>
		</div>

		<style>
			.darkmode,
			.darkmode .form-control,
			.darkmode .form-select {
				background-color: rgb(20, 20, 20) !important;
			}

			.darkmode .btn-light,
			.darkmode .bg-light,
			.darkmode .dropdown-menu,
			.darkmode .input-group-text,
			.darkmode .modal-content,
			.darkmode .form-control:disabled,
			.darkmode .form-select:disabled {
				background-color: rgb(36, 36, 36) !important;
			}

			.darkmode .form-control,
			.darkmode .form-select,
			.darkmode .btn-light,
			.darkmode .input-group-text,
			.darkmode .table,
			.darkmode .tr,
			.darkmode .thead,
			.darkmode .card,
			.darkmode .modal-header,
			.darkmode .modal-footer {
				border-color: rgb(56, 56, 56) !important;
			}

			.darkmode h3 {
				border-color: rgb(206, 212, 218) !important;
			}

			.darkmode .table>:not(:first-child) {
				border-top: 2px solid rgb(206, 212, 218) !important;
			}

			.darkmode a,
			.darkmode b,
			.darkmode p,
			.darkmode label,
			.darkmode span,
			.darkmode small,
			.darkmode div,
			.darkmode td,
			.darkmode hr,
			.darkmode .form-control,
			.darkmode .form-select {
				color: rgb(206, 212, 218);
			}

			.darkmode .btn,
			.darkmode h1,
			.darkmode h2,
			.darkmode h3,
			.darkmode h4,
			.darkmode h5,
			.darkmode .navbar-brand,
			.darkmode .dropdown-menu,
			.darkmode th,
			.darkmode .navbar-brand>span,
			.darkmode .navbar-brand>b,
			.darkmode .nav-item>*,
			.darkmode .input-group-text,
			.darkmode .input-group-text>* {
				color: rgb(255, 255, 255) !important;
			}

			.darkmode .btn-close,
			.darkmode .navbar-toggler {
				filter: invert(97%) sepia(2%) saturate(1242%) hue-rotate(180deg) brightness(93%) contrast(82%);
			}

			.darkmode .status-error .status-text {
				color: rgb(255, 191, 191);
			}

			.darkmode .status-warning .status-text {
				color: rgb(255, 241, 191);
			}

			.darkmode .status-ok .status-text {
				color: rgb(191, 255, 191);
			}

			.darkmode .status-na .status-text {
				color: rgb(155, 155, 155);
			}
		</style>

		<!-- Theme controls and toggle -->
		<script>
			const SITE_ROOT = $("body")
			const THEME_TOGGLE = $("#navbar-toggle-theme:checkbox")

			const THEME_PREFERENCE_LIGHT = "light"
			const THEME_PREFERENCE_DARK = "dark"

			function set_dark_mode(isdark) {
				if (isdark) {
					SITE_ROOT.addClass("darkmode")
				} else {
					SITE_ROOT.removeClass("darkmode")
				}
			}

			let theme_preference = Cookies.get("Theme-Preference")
			if (!theme_preference && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
				// Toggle dark mode right now
				THEME_TOGGLE.prop("checked", true)
				set_dark_mode(true)
			}

			THEME_TOGGLE.change(() => {
				Cookies.set(
					"Theme-Preference",
					THEME_TOGGLE.prop("checked") ? THEME_PREFERENCE_DARK : THEME_PREFERENCE_LIGHT,
					{path: window.location.pathname, sameSite: "Lax", secure: true, expires: 90}
				)
				set_dark_mode(THEME_TOGGLE.prop("checked"))
			})
		</script>

		<!-- Global modal utilities -->
		<script>
			const MODAL_JQ = $("#global-modal")
			const MODAL_BTN_DEFAULT = MODAL_JQ.find("#global-modal-btn-default")
			const MODAL_BTN_CONFIRM = MODAL_JQ.find("#global-modal-btn-confirm")

			const MODAL = new bootstrap.Modal(MODAL_JQ)

			let modal_busy = false
			let modal_action_confirmed = false
			let modal_close_handle = () => {}

			MODAL_BTN_CONFIRM.click(() => {
				modal_action_confirmed = true
			})
			MODAL_JQ.on("hidden.bs.modal", () => {
				modal_busy = false
				modal_close_handle(modal_action_confirmed)
				modal_close_handle = () => {}
			})

			function modal_setup(title, message, close_handle = () => {}) {
				if (modal_busy) {
					return false;
				}

				modal_busy = true
				modal_confirmed = false
				modal_close_handle = close_handle
				MODAL_JQ.find(".modal-title").text(title);

				let body = MODAL_JQ.find(".modal-body")
				body.empty()

				if (typeof question === "string") {
					body.text(message);
				} else {
					body.append(message);
				}

				return true
			}

			function modal_message(title, message, close_handle) {
				if (!modal_setup(title, message, close_handle)) {
					return false;
				}

				MODAL_BTN_DEFAULT.show().text("OK");
				MODAL_BTN_CONFIRM.hide();

				MODAL.show();
				return false; // handy when called from onclick
			}

			function modal_confirm(title, message, close_handle) {
				if (!modal_setup(title, message, close_handle)) {
					return false;
				}

				MODAL_BTN_CONFIRM.show().text("Yes");
				MODAL_BTN_DEFAULT.show().text("No");

				MODAL.show();
				return false; // handy when called from onclick
			}
		</script>

		<!-- API Handling Utilities -->
		<script>
			const LOADING = $("#global-loading-indicator")
			let ajax_num_executing_requests = 0;

			function hide_loading_indicator() {
				ajax_num_executing_requests--;
				if (ajax_num_executing_requests == 0) {
					// stop() prevents an ongoing fade from causing the thing to be shown again after this call
					LOADING.stop(true).hide();
				}
			}

			function ajax_with_indicator(options) {
				setTimeout(
					() => {
						if (ajax_num_executing_requests > 0) {
							LOADING.fadeIn()
						}
					}, 100
				);

				let success_f = options.success;
				let error_f = options.error;
				options.success = (data, _, jqxhr) => {
					if (success_f) {
						success_f(data, jqxhr);
					}
				};
				options.error = function (jqxhr) {
					if (!error_f) {
						modal_message("Error", "Something went wrong, sorry.")
					} else {
						error_f(jqxhr.responseText, jqxhr);
					}
				};
				options.complete = hide_loading_indicator

				ajax_num_executing_requests++;
				$.ajax(options);
				return false; // handy when called from onclick
			}

			function api(url, method, data, callback, callback_error, headers) {
				function default_error(text, xhr) {
					if (xhr.status != 403) {
						modal_message("Error", "Something went wrong, sorry.")
					}
				}

				let encoded = false
				let encoded_data = data
				if (method === "POST" || method === "PUT" || method === "PATCH") {
					encoded_data = JSON.stringify(data)
				}

				ajax_with_indicator({
					url: window.location.pathname + url,
					method: method,
					cache: false,
					data: encoded_data,
					headers: { ...headers, "X-Trusted-Origin-Token": Cookies.get("_Host-Trusted-Origin-Token") },
					contentType: typeof data == "string" ? "text/plain; charset=utf-8" : "application/json; charset=utf-8",
					dataType: "json",
					success: callback,
					error: callback_error || default_error,
					statusCode: {
						401: function (xhr) {
							// Credentials are no longer valid. Try to login again.
							do_logout();
							switch_back_to_panel = null;
						}
					}
				})
			}
		</script>

		<!-- Initialization -->
		{% if not authenticated %}
		<script>
			show_panel("login")
		</script>
		{% else %}
		<script>
			Object.keys(panel_functions).forEach(panel => {
				panel_functions[panel].unload()
			});
		</script>
		{% endif %}
	</body>
</html>
