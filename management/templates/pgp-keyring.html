<style>
    #pgp_keyring_config .status-error td {
		color: rgb(140, 0, 0);
	}

	#pgp_keyring_config .status-warning td {
		color: rgb(170, 120, 0);
	}

	#pgp_keyring_config .status-ok td {
		color: rgb(0, 140, 0);
	}

    #pgp_keyring_config .status-none {
        color: rgb(190, 190, 190);
    }

    #pgp_keyring_config #uids {
        white-space: pre-line;
    }
</style>

<h2>PGP Keyring Management</h2>

<template id="pgpkey-template">
    <tr>
        <td>
            <div id="trustlevel" style="font-size: 14pt;"><b>Trust Level:</b> Ultimate</div>
            <code id="uids">
                ðŸ¤– Power Mail-in-a-Box Management Daemon &lt;administrator@mailinabox.lan&gt;
            </code>
            <h3 style="font-size: 12pt;">Subkeys</h3>
            <table id="subkeys">
                <tr id="subkey-template">
                    <td id="ismaster">ðŸ”‘</td>
                    <td>
                        <b>
                            <a id="sign">S</a>
                            <a id="cert">C</a>
                            <a id="encr">E</a>
                            <a id="auth">A</a>
                        </b>
                    </td>
                    <td>
                        <b id="algo">RSA, 3072 bit</b>
                    </td>
                    <td>
                        <pre id="fpr">1756 6B81 D8A4 24C7 0098  659E 6872 2633 F692 52C6</pre>
                    </td>
                    <td id="expiration">
                        12/12/20 (119 days)
                    </td>
                </tr>
            </table>
        </td>
        <td style="width: 140pt;">
            <button id="export" class="btn btn-primary btn-block">Export Public Key</button>
        </td>
    </tr>
</template>

<div id="pgp_keyring_config">
    <h3>Daemon's Private Key</h3>
    <table id="privatekey" class="table container">  
    </table>

    <h3>Imported Public Keys</h3>
    <table id="pubkeys" class="table container">
    </table>
</div>

<script>
    function pretty_fpr(fpr) {
        let pfpr = ""
        for (let n = 0; n < 2; ++n) {
            for (let i = 0; i < 5; ++i) {
                pfpr += `${fpr.substring(n * 20 + i * 4, n * 20 + (i + 1) * 4)} `
            }
            pfpr += " "
        }

        return pfpr.substring(0, pfpr.length - 2)
    }

    function key_html(key, darken_bg, daemon) {
        let keyrep = $("#pgpkey-template").html()
        keyrep = $(keyrep)
        keyrep.attr("id", key.master_fpr)

        // Main key config
        if (darken_bg) {
            keyrep.addClass("bg-light")
        }
        let uidtxt = ""
        if (daemon) {
            keyrep.find("#trustlevel").html(`<b>Trust Level:</b> ${key.trust_level}`)
            key.ids.forEach(id => {
                uidtxt += "ðŸ¤– " + id + "\n"
            });
        } else {
            keyrep.find("#trustlevel").html(`<b>Trust Level:</b> ${key.trust_level} [<a href="#">change</a>]`)
            key.ids.forEach(id => {
                uidtxt += "ðŸ•µ " + id + "\n"
            });
        }
        keyrep.find("#uids").text(uidtxt.substring(0, uidtxt.length - 1))

        // Subkeys
        const keyflags = ["sign", "cert", "encr", "auth"]
        let subkeys = keyrep.find("#subkeys")
        let subkeytemplate = subkeys.html()
        keyrep.find("#subkey-template").remove()
        key.subkeys.forEach(skey => {
            let skeyrep = $(subkeytemplate)
            skeyrep.attr("id", `sub${skey.fpr}`)
            
            // Master key?
            if (skey.master) {
                skeyrep.find("#ismaster").html("ðŸ”‘")
            } else {
                skeyrep.find("#ismaster").html("")
            }

            // Usage flags
            keyflags.forEach(flag => {
                if (!skey[flag]) {
                    skeyrep.find(`#${flag}`).addClass("status-none")
                }
            });

            // Algorithm and fingerprint
            skeyrep.find("#algo").html(`${skey.algorithm}, ${skey.bits} bits`)
            skeyrep.find("#fpr").html(pretty_fpr(skey.fpr))
            let expiration = skeyrep.find("#expiration")

            // Expiration
            if (skey.expired) {
                skeyrep.addClass("status-error")
                expiration.html(`${skey.expires_date} (expired)`)
            } else if (skey.expires && skey.expires_days <= 14) {
                skeyrep.addClass("status-warning")
                expiration.html(`${skey.expires_date} (${skey.expires_days} days)`)
            } else if (skey.expires) {
                skeyrep.addClass("status-ok")
                expiration.html(`${skey.expires_date} (${skey.expires_days} days)`)
            } else {
                skeyrep.addClass("status-ok")
                expiration.html("Does not expire")
            }
            skeyrep.appendTo(subkeys)
        });

        return keyrep
    }

    function show_pgp_keyring() {
        $('#privatekey tbody').html("<tr><td class='text-muted'>Loading...</td></tr>")
        $('#pubkeys tbody').html("<tr><td class='text-muted'>Loading...</td></tr>")
        api(
            "/system/pgp/",
            "GET",
            {},
            function(r) {
                key_html(r.daemon, true, true).appendTo("#privatekey")
                let pendulum = 1
                r.imported.forEach(k => {
                    key_html(k, pendulum > 0, false).appendTo("#pubkeys")
                    pendulum *= -1
                });
            }
        )
    }
</script>
