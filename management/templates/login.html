<style>
	.title {
		margin: 0.5em;
		text-align: center;
	}

	.subtitle {
		margin: 1em;
		text-align: center;
	}

	.login {
		margin: 0 auto;
		max-width: 32em;
	}

	.login #login-totp-prompt {
		display: none;
	}

	#loginForm.is-twofactor #login-totp-prompt {
		display: block
	}
</style>

<h1 class="title">{{hostname}}</h1>

{% if no_users_exist or no_admins_exist %}
<div class="row">
	<div class="col-12">
		<hr>
		{% if no_users_exist %}
		<p class="text-danger">There are no users on this system! To make an administrative user,
			log into this machine using SSH (like when you first set it up) and run:</p>
		<pre>cd mailinabox
sudo management/cli.py user add me@{{hostname}}
sudo management/cli.py user make-admin me@{{hostname}}</pre>
		{% else %}
		<p class="text-danger">There are no administrative users on this system! To make an administrative user,
			log into this machine using SSH (like when you first set it up) and run:</p>
		<pre>cd mailinabox
sudo management/cli.py user make-admin me@{{hostname}}</pre>
		{% endif %}
		<hr>
	</div>
</div>
{% endif %}

<p class="subtitle">Log in here for your Mail-in-a-Box control panel.</p>

<div class="login">
	<form id="login-form" class="form-horizontal" role="form" onsubmit="do_login(); return false;" method="get">
		<div class="form-floating mb-3">
			<input type="email" class="form-control col-sm-12" id="login-email" placeholder="user@example.com">
			<label for="login-email">Email</label>
		</div>
		<div class="form-floating mb-3">
			<input type="password" class="form-control col-sm-12" id="login-password" placeholder="password">
			<label for="login-password">Password</label>
		</div>
		<div class="form-floating mb-3" id="login-totp-prompt">
			<input type="text" class="form-control" id="login-totp-token" placeholder="000000" autocomplete="off">
			<label for="login-totp-token">TOTP Code</label>
			<div class="help-block" style="margin-top: 5px; font-size: 90%">Enter the six-digit code generated by your two
				factor authentication app.</div>
		</div>
		<div class="form-group mb-3">
			<div class="ms-auto">
				<input type="checkbox" class="form-check-input" id="loginRemember">
				<label class="form-check-label" for="loginRemember">Remember Me</label>
			</div>
		</div>
		<div class="form-group">
			<div class="container-fluid">
				<button disabled id="login-submit" type="submit" class="btn btn-primary col-12">Sign in</button>
			</div>
		</div>
	</form>
</div>

<script>
	let login_confirmation_token = undefined
	function show_login() {
		$("#login-email").on("input", set_submit_button_enabled)
		$("#login-password").on("input", set_submit_button_enabled)
		$("#login-totp-token").on("input", set_submit_button_enabled)
	}

	function can_do_login() {
		return (!login_confirmation_token && $("#login-email").val() !== "" && $("#login-password").val() !== "")
			|| (login_confirmation_token && $("#login-totp-token").val().length === 6)
	}

	function set_submit_button_enabled() {
		$("#login-submit").attr("disabled", !can_do_login())
	}

	function do_login() {
		if (!can_do_login()) {
			if (login_confirmation_token) {
				modal_message("Login Failed!", "Please fill in the TOTP token.")
			} else {
				modal_message("Login Failed!", "Please fill in the email address and password.")
			}
		}

		let credentials = {
			username: $("#login-email").val(),
			long_lived: $('#loginRemember').val()
		}

		if (login_confirmation_token) {
			// We're at the TOTP phase:
			credentials.confirmation_token = login_confirmation_token
			credentials.totp_token = $("#login-totp-token").val()
		} else {
			credentials.password = $("#login-password").val()
		}

		api(
			"/login",
			"POST",
			credentials,
			(response, _, xhr) => {
				if (xhr.status == 202) {
					// The username and password are correct, but we still need a valid TOTP token to complete authentication.
					login_confirmation_token = response.confirmation_token
					// Disable the email/password forms so that the user doesn't use them
					$("#login-email").attr("disabled", true);
					$("#login-password").val("").attr("disabled", true)

					$("#loginForm").addClass("is-twofactor");
					$("#login-totp-token").focus();
				} else if (xhr.status == 205) {
					// no-op: Login was successful and the page will reload
				}
			},
			(response) => {
				switch (response.code) {
					case "INVALID_USER_PASSWORD":
						// Either the username or the password are incorrect
						modal_message("Login Failed!", "Incorrect username or password.")
						break;
					case "TOTP_TOKEN_INVALID":
						// The TOTP token is incorrect
						modal_message("Login Failed!", "The TOTP token is incorrect.")
						break;
					case "CONFIRMATION_TOKEN_INVALID":
						// The login confirmation token is not valid for the provided username
						// In this context, it most likely means that said token has expired
						// and that we'll need to log in again.
						login_confirmation_token = undefined
						$("#login-email").attr("disabled", false);
						$("#login-password").attr("disabled", false);
						$("#login-totp-token").val("");

						modal_message("Login Failed!", "The 2FA login window has expired and is now invalid. Please log in again.")
						$("#login-password").focus();
						break;
					default:
						break;
				}
			},
		)
	}
</script>
